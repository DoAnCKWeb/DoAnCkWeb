{{#if message}}
<div class="alert alert-danger" role="alert">
  {{message}}
</div>
{{/if}}
<div class="container my-5">
  <!-- Hiển thị danh mục -->
  <div class="d-flex flex-wrap border p-3 rounded shadow-lg bg-light">
    <ul class="nav me-4">
      <!-- Nút hiển thị tất cả -->
      <li class="nav-item mx-2 mb-2">
        <a class="nav-link p-3 bg-white rounded border custom-border-color text-center text-dark fw-bold"
           href="#"
           onclick="filterProducts('all', 1)"
           style="font-size: 1.5rem; transition: all 0.3s ease; padding-left: 20px; padding-right: 20px;">
          Tất cả
        </a>
      </li>
      <!-- Danh mục -->
      {{#each categories}}
      <li class="nav-item mx-2 mb-2">
        <a class="nav-link p-3 bg-white rounded border custom-border-color text-center text-dark fw-bold"
           href="#"
           onclick="filterProducts({{id}}, 1)"
           style="font-size: 1.5rem; transition: all 0.3s ease; padding-left: 20px; padding-right: 20px;">
          {{name}}
        </a>
      </li>
      {{/each}}
    </ul>
  </div>

  <!-- Hiển thị sản phẩm -->
  <div class="row" id="product-container">
    {{#each products}}
    <div class="col-md-3 mb-4">
      <div class="card h-100 text-center">
        <img src="{{image}}" class="card-img-top" alt="{{product_name}}" style="height: 250px; width: 250px; text-align: center; margin: 0 auto; display: block;">
        <div class="card-body">
          <h5 class="card-title">{{product_name}}</h5>
          <p class="card-text">Giá: {{formatCurrency price}}</p>
          <a href="/product/{{product_id}}" class="btn btn-success">Xem chi tiết</a>
          <button onclick="addToCart({{product_id}}, 1)" class="btn btn-primary">Thêm vào giỏ hàng</button>
        </div>
      </div>
    </div>
    {{/each}}
  </div>

  <!-- Phân trang -->
  <div class="d-flex justify-content-center mt-4">
    <nav aria-label="Page navigation">
      <ul class="pagination" id="pagination-container">
        {{#if (gt currentPage 1)}}
        <li class="page-item">
          <a class="page-link" href="#" onclick="changePage({{subtract currentPage 1}})">&laquo;</a>
        </li>
        {{/if}}

        {{#each (range 1 totalPages)}}
        <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
          <a class="page-link" href="#" onclick="changePage({{this}})">{{this}}</a>
        </li>
        {{/each}}

        {{#if (lt currentPage totalPages)}}
        <li class="page-item">
          <a class="page-link" href="#" onclick="changePage({{add currentPage 1}})">&raquo;</a>
        </li>
        {{/if}}
      </ul>
    </nav>
  </div>
</div>

<script>
  let currentCategory = 'all'; // Mặc định danh mục hiện tại là "Tất cả"

  // Lọc sản phẩm theo danh mục và trang
  function filterProducts(categoryId, page) {
    currentCategory = categoryId; // Cập nhật danh mục hiện tại
    fetch(`/products?category=${categoryId}&page=${page}`)
      .then(response => response.json())
      .then(data => {
        const productContainer = document.querySelector('#product-container');
        const paginationContainer = document.querySelector('#pagination-container');

        // Xóa sản phẩm cũ
        productContainer.innerHTML = '';
        data.products.forEach(product => {
          productContainer.innerHTML += `
            <div class="col-md-3 mb-4">
              <div class="card h-100 text-center">
                <img src="${product.image}" class="card-img-top" alt="${product.product_name}" style="height: 250px; width: 250px; text-align: center; margin: 0 auto; display: block;">
                <div class="card-body">
                  <h5 class="card-title">${product.product_name}</h5>
                  <p class="card-text">Giá: ${formatCurrency(product.price)}</p>
                  <a href="/product/${product.product_id}" class="btn btn-success">Xem chi tiết</a>
                  <button onclick="addToCart(${product.product_id}, 1)" class="btn btn-primary">Thêm vào giỏ hàng</button>
                </div>
              </div>
            </div>
          `;
        });

        // Cập nhật phân trang
        paginationContainer.innerHTML = '';
        if (data.currentPage > 1) {
          paginationContainer.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${data.currentPage - 1})">&laquo;</a></li>`;
        }
        for (let i = 1; i <= data.totalPages; i++) {
          paginationContainer.innerHTML += `<li class="page-item ${i === data.currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${i})">${i}</a></li>`;
        }
        if (data.currentPage < data.totalPages) {
          paginationContainer.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${data.currentPage + 1})">&raquo;</a></li>`;
        }
      });
  }

  // Hàm format tiền tệ
  function formatCurrency(value) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
  }

  // Khi chuyển trang
  function changePage(page) {
    filterProducts(currentCategory, page);
  }
</script>

