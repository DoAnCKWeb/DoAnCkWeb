{{#if message}}
<div class="alert alert-danger" role="alert">
  {{message}}
</div>
{{/if}}

<div class="container my-5">
  <div class="row">
    <!-- Hiển thị danh mục (Bên trên) -->
    <div class="col-md-12 mb-4">
      <div class="d-flex flex-wrap border p-3 rounded shadow-lg bg-light mb-4">
        <ul class="nav me-4">
          <!-- Nút hiển thị tất cả -->
          <li class="nav-item mx-2 mb-2">
            <a class="nav-link p-3 bg-white rounded border custom-border-color text-center text-dark fw-bold"
               href="#"
               onclick="filterProducts('all', 1)"
               style="font-size: 1.5rem; transition: all 0.3s ease; padding-left: 20px; padding-right: 20px;">
              Tất cả
            </a>
          </li>
          <!-- Danh mục -->
          {{#each categories}}
          <li class="nav-item mx-2 mb-2">
            <a class="nav-link p-3 bg-white rounded border custom-border-color text-center text-dark fw-bold"
               href="#"
               onclick="filterProducts({{id}}, 1)"
               style="font-size: 1.5rem; transition: all 0.3s ease; padding-left: 20px; padding-right: 20px;">
              {{name}}
            </a>
          </li>
          {{/each}}
        </ul>
      </div>
    </div>

    <!-- Bộ lọc sản phẩm (Bên trái) -->
    <div class="col-md-3 mb-4">
      <div class="p-3 border rounded shadow-lg">
        <h5 class="mb-3">Bộ lọc</h5>

        <!-- Bộ lọc giá -->
        <h6>Giá</h6>
        <input type="number" id="min-price" class="form-control mb-2" placeholder="Giá tối thiểu">
        <input type="number" id="max-price" class="form-control mb-3" placeholder="Giá tối đa">

        <!-- Phần thông báo lỗi giá -->
        <div id="price-error" class="text-danger" style="display: none;">Giá tối đa phải lớn hơn hoặc bằng giá tối thiểu.</div>

        <!-- Bộ lọc dung lượng -->
        <h6>Dung lượng</h6>
        <select id="storage" class="form-select mb-3">
          <option value="">Tất cả</option>
          <option value="64GB">64GB</option>
          <option value="128GB">128GB</option>
          <option value="256GB">256GB</option>
          <option value="512GB">512GB</option>
          <option value="1TB">512GB</option>
        </select>

        <!-- Bộ lọc năm sản xuất -->
        <h6>Năm sản xuất</h6>
        <select id="release-year" class="form-select mb-3">
          <option value="">Tất cả</option>
          <option value="2023">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
        </select>

        <!-- Bộ lọc hệ điều hành -->
        <h6>Hệ điều hành</h6>
        <select id="os" class="form-select mb-3">
          <option value="">Tất cả</option>
          <option value="Android">Android</option>
          <option value="iOS">iOS</option>
        </select>

        <!-- Bộ lọc theo giá -->
        <h6>Sắp xếp theo giá</h6>
        <select id="price-sort" class="form-select mb-3">
          <option value="">Tất cả</option>
          <option value="asc">Giá từ thấp đến cao</option>
          <option value="desc">Giá từ cao đến thấp</option>
        </select>

        <button class="btn btn-primary w-100 mt-3" onclick="filterProducts(currentCategory, 1)">Lọc</button>
      </div>
    </div>

    <!-- Hiển thị sản phẩm (Bên phải) -->
    <div class="col-md-9">
      <div class="row" id="product-container">
        {{#each products}}
        <div class="col-md-4 mb-4">
          <div class="card h-100 text-center">
            <img src="{{image}}" class="card-img-top" alt="{{product_name}}" style="height: 250px; width: 250px; text-align: center; margin: 0 auto; display: block;">
            <div class="card-body">
              <h5 class="card-title">{{product_name}}</h5>
              <p class="card-text">Giá: {{formatCurrency price}}</p>
              <a href="/product/{{product_id}}" class="btn btn-success">Xem chi tiết</a>
              <button onclick="addToCart({{product_id}}, 1)" class="btn btn-primary">Thêm vào giỏ hàng</button>
            </div>
          </div>
        </div>
        {{/each}}
      </div>

      <!-- Phân trang -->
      <div class="d-flex justify-content-center mt-4">
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination-container">
            {{#if (gt currentPage 1)}}
            <li class="page-item">
              <a class="page-link" href="#" onclick="changePage({{subtract currentPage 1}})">&laquo;</a>
            </li>
            {{/if}}

            {{#each (range 1 totalPages)}}
            <li class="page-item {{#if (eq this ../currentPage)}}active{{/if}}">
              <a class="page-link" href="#" onclick="changePage({{this}})">{{this}}</a>
            </li>
            {{/each}}

            {{#if (lt currentPage totalPages)}}
            <li class="page-item">
              <a class="page-link" href="#" onclick="changePage({{add currentPage 1}})">&raquo;</a>
            </li>
            {{/if}}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<style>
  .selected-category {
    background-color: red !important;
    color: white !important;
  }
</style>

<script>
  let currentCategory = 'all'; // Mặc định danh mục hiện tại là "Tất cả"

  // Lọc sản phẩm theo danh mục và trang
  function filterProducts(categoryId, page) {
    currentCategory = categoryId; // Cập nhật danh mục hiện tại

    // Lấy các giá trị từ bộ lọc
    const minPrice = document.getElementById('min-price').value || '';
    const maxPrice = document.getElementById('max-price').value || '';
    const storage = document.getElementById('storage').value || '';
    const priceSort = document.getElementById('price-sort').value || ''; // Lọc theo giá
    const releaseYear = document.getElementById('release-year').value || ''; // Lọc theo năm sản xuất
    const os = document.getElementById('os').value || '';

    // Kiểm tra nếu cả minPrice và maxPrice đều được nhập, kiểm tra minPrice và maxPrice hợp lệ
    if (minPrice && maxPrice && parseFloat(maxPrice) < parseFloat(minPrice)) {
      // Hiển thị thông báo lỗi
      document.getElementById('price-error').style.display = 'block';
      return; // Dừng lại không gửi request AJAX
    } else {
      // Nếu không có lỗi, ẩn thông báo lỗi
      document.getElementById('price-error').style.display = 'none';
    }

    // Xây dựng URL với các tham số bộ lọc
    let url = `/products?category=${categoryId}&page=${page}&minPrice=${minPrice}&maxPrice=${maxPrice}&storage=${storage}&priceSort=${priceSort}&releaseYear=${releaseYear}&os=${os}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const productContainer = document.querySelector('#product-container');
        const paginationContainer = document.querySelector('#pagination-container');

        // Xóa sản phẩm cũ
        productContainer.innerHTML = '';
        data.products.forEach(product => {
          productContainer.innerHTML += `
            <div class="col-md-4 mb-4">
              <div class="card h-100 text-center">
                <img src="${product.image}" class="card-img-top" alt="${product.product_name}" style="height: 250px; width: 250px; text-align: center; margin: 0 auto; display: block;">
                <div class="card-body">
                  <h5 class="card-title">${product.product_name}</h5>
                  <p class="card-text">Giá: ${formatCurrency(product.price)}</p>
                  <a href="/product/${product.product_id}" class="btn btn-success">Xem chi tiết</a>
                  <button onclick="addToCart(${product.product_id}, 1)" class="btn btn-primary">Thêm vào giỏ hàng</button>
                </div>
              </div>
            </div>
          `;
        });

        // Cập nhật phân trang
        paginationContainer.innerHTML = '';
        if (data.currentPage > 1) {
          paginationContainer.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${data.currentPage - 1})">&laquo;</a></li>`;
        }
        for (let i = 1; i <= data.totalPages; i++) {
          paginationContainer.innerHTML += `<li class="page-item ${i === data.currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${i})">${i}</a></li>`;
        }
        if (data.currentPage < data.totalPages) {
          paginationContainer.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="filterProducts('${categoryId}', ${data.currentPage + 1})">&raquo;</a></li>`;
        }
      });
  }

  // Hàm format tiền tệ
  function formatCurrency(value) {
    return new Intl.NumberFormat('vi-VN').format(value) + ' VND';
  }

  // Khi chuyển trang
  function changePage(page) {
    filterProducts(currentCategory, page);
  }
</script>